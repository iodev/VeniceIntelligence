{% extends "base.html" %}

{% block title %}Chat History{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Chat History
                    </h5>
                    <button class="btn btn-sm btn-primary" onclick="createNewSession()">
                        <i class="bi bi-plus"></i> New
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="sessionsList" class="list-group list-group-flush">
                        <!-- Sessions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0" id="currentSessionTitle">
                            <i class="bi bi-chat-dots me-2"></i>Select a conversation
                        </h5>
                        <small class="text-muted" id="currentSessionDate"></small>
                    </div>
                    <div id="sessionActions" class="d-none">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="shareSession()">
                                <i class="bi bi-share"></i> Share
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportSession()">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSession()">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="conversationView" style="height: 500px; overflow-y: auto;">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-text display-4"></i>
                            <p class="mt-3">Select a conversation from the history to view its messages</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label class="form-label">Share Link:</label>
                    <div class="input-group">
                        <input type="text" id="shareUrl" class="form-control" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyShareUrl()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Anyone with this link can view the conversation, but they cannot modify it.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSessionId = null;
let sessions = [];

// Load sessions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSessions();
});

async function loadSessions() {
    try {
        const response = await fetch('/api/sessions');
        const data = await response.json();
        sessions = data.sessions;
        renderSessionsList();
    } catch (error) {
        console.error('Error loading sessions:', error);
    }
}

function renderSessionsList() {
    const container = document.getElementById('sessionsList');
    container.innerHTML = '';
    
    if (sessions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-chat-text"></i>
                <p class="mt-2 mb-0">No conversations yet</p>
            </div>
        `;
        return;
    }
    
    sessions.forEach(session => {
        const sessionItem = document.createElement('a');
        sessionItem.href = '#';
        sessionItem.className = 'list-group-item list-group-item-action';
        sessionItem.onclick = (e) => {
            e.preventDefault();
            selectSession(session.id);
        };
        
        const date = new Date(session.updated_at).toLocaleDateString();
        const messageCount = session.message_count || 0;
        
        sessionItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${session.title}</h6>
                <small>${date}</small>
            </div>
            <p class="mb-1 text-muted">${messageCount} messages</p>
        `;
        
        container.appendChild(sessionItem);
    });
}

async function selectSession(sessionId) {
    try {
        // Highlight selected session
        document.querySelectorAll('#sessionsList .list-group-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.closest('.list-group-item').classList.add('active');
        
        currentSessionId = sessionId;
        
        // Load session messages
        const response = await fetch(`/api/sessions/${sessionId}`);
        const data = await response.json();
        
        // Update header
        document.getElementById('currentSessionTitle').innerHTML = `
            <i class="bi bi-chat-dots me-2"></i>${data.session.title}
        `;
        document.getElementById('currentSessionDate').textContent = 
            new Date(data.session.created_at).toLocaleString();
        document.getElementById('sessionActions').classList.remove('d-none');
        
        // Render messages
        renderMessages(data.messages);
        
    } catch (error) {
        console.error('Error loading session:', error);
    }
}

function renderMessages(messages) {
    const container = document.getElementById('conversationView');
    container.innerHTML = '';
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-text display-4"></i>
                <p class="mt-3">This conversation has no messages yet</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-container mb-3';
        
        const timestamp = new Date(message.timestamp).toLocaleTimeString();
        const isUser = message.message_type === 'user';
        
        messageDiv.innerHTML = `
            <div class="${isUser ? 'user' : 'assistant'}-message">
                <div class="d-flex align-items-start">
                    <div class="message-avatar ${isUser ? 'bg-primary' : 'bg-success'} text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="bi ${isUser ? 'bi-person-fill' : 'bi-robot'}"></i>
                    </div>
                    <div class="message-content flex-grow-1">
                        <div class="message-header mb-1">
                            <strong>${isUser ? 'User' : 'üèõÔ∏è Venice.ai Agent'}</strong>
                            <small class="text-muted ms-2">${timestamp}</small>
                            ${message.query_type ? `<span class="badge bg-info ms-2">${message.query_type}</span>` : ''}
                            ${message.model_used ? `<span class="badge bg-warning text-dark ms-2">${message.model_used}</span>` : ''}
                            ${message.provider_used ? `<span class="badge bg-secondary ms-1">${message.provider_used}</span>` : ''}
                        </div>
                        <div class="message-body">
                            ${message.content}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

async function createNewSession() {
    try {
        const title = prompt('Enter a title for the new conversation:', 
                           `Chat ${new Date().toLocaleString()}`);
        if (!title) return;
        
        const response = await fetch('/api/sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title: title })
        });
        
        const newSession = await response.json();
        sessions.unshift(newSession);
        renderSessionsList();
        selectSession(newSession.id);
        
    } catch (error) {
        console.error('Error creating session:', error);
        alert('Failed to create new session');
    }
}

async function shareSession() {
    if (!currentSessionId) return;
    
    try {
        const response = await fetch(`/api/sessions/${currentSessionId}/share`, {
            method: 'POST'
        });
        const data = await response.json();
        
        document.getElementById('shareUrl').value = data.share_url;
        new bootstrap.Modal(document.getElementById('shareModal')).show();
        
    } catch (error) {
        console.error('Error sharing session:', error);
        alert('Failed to create share link');
    }
}

function copyShareUrl() {
    const shareUrl = document.getElementById('shareUrl');
    shareUrl.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i> Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

function exportSession() {
    if (!currentSessionId) return;
    
    const format = prompt('Export format (json or markdown):', 'json');
    if (format && (format === 'json' || format === 'markdown')) {
        window.open(`/api/sessions/${currentSessionId}/export?format=${format}`, '_blank');
    }
}

async function deleteSession() {
    if (!currentSessionId) return;
    
    if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/sessions/${currentSessionId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Remove from local sessions array
            sessions = sessions.filter(s => s.id !== currentSessionId);
            renderSessionsList();
            
            // Clear current view
            currentSessionId = null;
            document.getElementById('currentSessionTitle').innerHTML = 
                '<i class="bi bi-chat-dots me-2"></i>Select a conversation';
            document.getElementById('currentSessionDate').textContent = '';
            document.getElementById('sessionActions').classList.add('d-none');
            document.getElementById('conversationView').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-text display-4"></i>
                    <p class="mt-3">Conversation deleted successfully</p>
                </div>
            `;
        } else {
            throw new Error('Failed to delete session');
        }
        
    } catch (error) {
        console.error('Error deleting session:', error);
        alert('Failed to delete conversation');
    }
}
</script>
{% endblock %}