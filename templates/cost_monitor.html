{% extends 'base.html' %}

{% block title %}Cost Monitor{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>AI Cost Monitoring & Optimization</h1>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Cost Usage Summary</h5>
                </div>
                <div class="card-body">
                    {% if cost_summary and cost_summary.daily_spend is defined %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Daily Usage</h6>
                            <p class="h4 text-primary">${{ cost_summary.daily_spend|round(3) }}</p>
                            <p class="text-muted">Of ${{ cost_summary.daily_budget|round(2) }} budget</p>
                            
                            <div class="progress mb-3">
                                {% set percent = (cost_summary.daily_spend / cost_summary.daily_budget * 100)|round(0) %}
                                <div class="progress-bar {% if percent > 90 %}bg-danger{% elif percent > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                     role="progressbar" style="width: {{ percent }}%" 
                                     aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ percent }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Total Usage</h6>
                            <p class="h4 text-primary">${{ cost_summary.total_spend|round(2) }}</p>
                            
                            <h6 class="mt-3">Request Count</h6>
                            <p>{{ cost_summary.request_count }} requests</p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Cost by Provider</h6>
                    <div class="mt-3">
                        {% if cost_summary.provider_costs %}
                            {% for provider, amount in cost_summary.provider_costs.items() %}
                            <div class="d-flex justify-content-between mb-1">
                                <span>{{ provider|title }}</span>
                                <span>${{ amount|round(3) }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No provider costs recorded yet</p>
                        {% endif %}
                    </div>
                    
                    <h6 class="mt-3">Cost by Request Type</h6>
                    <div class="mt-3">
                        {% if cost_summary.request_type_costs %}
                            {% for type, amount in cost_summary.request_type_costs.items() %}
                            <div class="d-flex justify-content-between mb-1">
                                <span>{{ type|title }}</span>
                                <span>${{ amount|round(3) }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No request type costs recorded yet</p>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-muted">No cost data available yet. Start using the system to track costs.</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Update Daily Budget</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_budget') }}" method="POST">
                        <div class="form-group">
                            <label for="daily_budget">Daily Budget (USD)</label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">$</span>
                                </div>
                                <input type="number" class="form-control" id="daily_budget" name="daily_budget" 
                                       step="0.01" min="0.01" value="{{ strategy.daily_budget if strategy else 1.0 }}">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Update Budget</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Model Selection Strategy</h5>
                </div>
                <div class="card-body">
                    {% if strategy %}
                    <h6>{{ strategy.name }}</h6>
                    <p class="text-muted">{{ strategy.description }}</p>
                    
                    <h6 class="mt-3">Priority Weights</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center mb-2">Cost</div>
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ strategy.prioritize_cost * 100 }}%" 
                                     aria-valuenow="{{ strategy.prioritize_cost * 100 }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ (strategy.prioritize_cost * 100)|round(0) }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center mb-2">Speed</div>
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {{ strategy.prioritize_speed * 100 }}%" 
                                     aria-valuenow="{{ strategy.prioritize_speed * 100 }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ (strategy.prioritize_speed * 100)|round(0) }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center mb-2">Accuracy</div>
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: {{ strategy.prioritize_accuracy * 100 }}%" 
                                     aria-valuenow="{{ strategy.prioritize_accuracy * 100 }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ (strategy.prioritize_accuracy * 100)|round(0) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mt-3">Cost Saving Threshold</h6>
                    <p>System will switch to cost-saving mode at {{ (strategy.cost_threshold * 100)|round(0) }}% of daily budget</p>
                    
                    <h6 class="mt-3">Fallback Model</h6>
                    <p>{{ strategy.fallback_model }}</p>
                    
                    <a class="btn btn-info btn-sm mt-2" data-toggle="collapse" href="#updateStrategyForm" role="button">
                        Update Strategy
                    </a>
                    {% else %}
                    <p class="text-muted">No strategy configured. Set up a new strategy below.</p>
                    <a class="btn btn-info btn-sm" data-toggle="collapse" href="#updateStrategyForm" role="button">
                        Configure Strategy
                    </a>
                    {% endif %}
                    
                    <div class="collapse mt-3" id="updateStrategyForm">
                        <form action="{{ url_for('update_strategy') }}" method="POST">
                            <div class="form-group">
                                <label for="name">Strategy Name</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ strategy.name if strategy else 'Balanced Strategy' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="2">{{ strategy.description if strategy else 'Balance between cost, speed, and accuracy' }}</textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="prioritize_cost">Cost Weight</label>
                                    <input type="number" class="form-control" id="prioritize_cost" name="prioritize_cost" 
                                           step="0.1" min="0" max="1" value="{{ strategy.prioritize_cost if strategy else 0.3 }}">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="prioritize_speed">Speed Weight</label>
                                    <input type="number" class="form-control" id="prioritize_speed" name="prioritize_speed" 
                                           step="0.1" min="0" max="1" value="{{ strategy.prioritize_speed if strategy else 0.3 }}">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="prioritize_accuracy">Accuracy Weight</label>
                                    <input type="number" class="form-control" id="prioritize_accuracy" name="prioritize_accuracy" 
                                           step="0.1" min="0" max="1" value="{{ strategy.prioritize_accuracy if strategy else 0.4 }}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="cost_threshold">Cost Threshold (0-1)</label>
                                <input type="number" class="form-control" id="cost_threshold" name="cost_threshold" 
                                       step="0.1" min="0" max="1" value="{{ strategy.cost_threshold if strategy else 0.8 }}">
                                <small class="form-text text-muted">Fraction of daily budget before switching to cost-saving mode</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="fallback_model">Fallback Model</label>
                                <input type="text" class="form-control" id="fallback_model" name="fallback_model" 
                                       value="{{ strategy.fallback_model if strategy else 'llama-3.2-3b' }}">
                                <small class="form-text text-muted">Low-cost model to use when budget is nearly exhausted</small>
                            </div>
                            
                            <hr>
                            <h6>Task-Model Mappings</h6>
                            
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Text Tasks</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="text_mapping_general">General</label>
                                            <input type="text" class="form-control" id="text_mapping_general" name="text_mapping_general" 
                                                   value="llama-3.1-sonar-small-128k-online">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="text_mapping_creative">Creative</label>
                                            <input type="text" class="form-control" id="text_mapping_creative" name="text_mapping_creative" 
                                                   value="claude-3.5-sonnet-20241022">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="text_mapping_analytical">Analytical</label>
                                            <input type="text" class="form-control" id="text_mapping_analytical" name="text_mapping_analytical" 
                                                   value="mistral-31-24b">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Code Tasks</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="code_mapping_general">General</label>
                                            <input type="text" class="form-control" id="code_mapping_general" name="code_mapping_general" 
                                                   value="mistral-31-24b">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="code_mapping_python">Python</label>
                                            <input type="text" class="form-control" id="code_mapping_python" name="code_mapping_python" 
                                                   value="mistral-31-24b">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="code_mapping_javascript">JavaScript</label>
                                            <input type="text" class="form-control" id="code_mapping_javascript" name="code_mapping_javascript" 
                                                   value="llama-3.2-3b">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Image Tasks</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="image_mapping_general">General</label>
                                        <input type="text" class="form-control" id="image_mapping_general" name="image_mapping_general" 
                                               value="stable-diffusion-xl-1024-v1-0">
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Update Strategy</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Model Efficiency Metrics</h5>
                </div>
                <div class="card-body">
                    {% if efficiency_metrics %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Provider</th>
                                    <th>Task Type</th>
                                    <th>Response Time (s)</th>
                                    <th>Tokens/Second</th>
                                    <th>Cost/100 Tokens</th>
                                    <th>Accuracy</th>
                                    <th>User Satisfaction</th>
                                    <th>Efficiency Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metric in efficiency_metrics %}
                                <tr>
                                    <td>{{ metric.model_id }}</td>
                                    <td>{{ metric.provider }}</td>
                                    <td>{{ metric.task_type }}</td>
                                    <td>{{ metric.avg_time_to_first_token|round(3) }}</td>
                                    <td>{{ metric.avg_tokens_per_second|round(1) }}</td>
                                    <td>${{ metric.avg_cost_per_100_tokens|round(4) }}</td>
                                    <td>{{ (metric.accuracy_score * 100)|round(1) }}%</td>
                                    <td>{{ (metric.user_satisfaction * 100)|round(1) }}%</td>
                                    <td>{{ metric.efficiency_score|round(2) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No efficiency metrics available yet. The system will collect metrics as you use different models.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}